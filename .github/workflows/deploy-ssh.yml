name: Deploy to Server

on:
  push:
    branches:
      - production  # Deploy only on push to production branch
  workflow_dispatch:  # Allow manual deployment from Actions tab

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Show runner IP address
        run: |
          echo "GitHub Runner Public IP Address:"
          curl -s https://api.ipify.org
          echo ""
          echo "Alternate check:"
          curl -s https://checkip.amazonaws.com

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Build with Docker (builder stage)
        env:
          SATVIS_BASE_PATH: ${{ secrets.SATVIS_BASE_PATH }}
        run: |
          # Build the builder stage which contains the compiled app in /app/dist
          docker build --target builder -f Dockerfile.web -t satvis-builder:${{ github.sha }} \
            --build-arg SATVIS_BASE_PATH="${SATVIS_BASE_PATH}" .

      - name: Extract build artifacts from Docker
        run: |
          # Create a container from the builder image
          docker create --name satvis-extract satvis-builder:${{ github.sha }}

          # Copy the /app/dist directory to ./dist
          docker cp satvis-extract:/app/dist ./dist

          # Clean up the container
          docker rm satvis-extract

      - name: Setup Node.js (for TLE updates only)
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Update TLE data
        run: npm run update-tle

      - name: Update prelaunch data
        run: |
          cd data/tle
          sh update-prelaunch-data.sh
          mv prelaunch.txt groups/

      - name: Copy TLE data to dist
        run: |
          # Copy freshly updated TLE data into the dist folder
          cp -r data/tle/groups dist/data/tle/

      - name: Setup SSH
        env:
          SSH_HOST: ${{ secrets.SSH_DEPLOY_HOST }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_DEPLOY_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Debug: Check if secrets are accessible
          echo "Checking environment variables..."
          echo "SSH_HOST is set: $([ -n "${SSH_HOST}" ] && echo 'YES' || echo 'NO')"
          echo "SSH_HOST length: ${#SSH_HOST}"

          # Verify SSH_HOST is set
          if [ -z "${SSH_HOST}" ]; then
            echo "Error: SSH_HOST is not set or empty"
            exit 1
          fi

          # Add server to known_hosts
          echo "Adding host to known_hosts..."
          ssh-keyscan -H "${SSH_HOST}" 2>&1 | tee -a ~/.ssh/known_hosts || {
            echo "Error: ssh-keyscan failed for host"
            exit 1
          }

          echo "✓ SSH setup completed successfully"

      - name: Deploy to server
        env:
          SSH_HOST: ${{ secrets.SSH_DEPLOY_HOST }}
          SSH_USER: ${{ secrets.SSH_DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.SSH_DEPLOY_PATH }}
        run: |
          # Create deployment archive
          cd dist
          tar -czf ../satvis-deploy.tar.gz .
          cd ..

          # Upload the archive to parent directory
          PARENT_DIR=$(dirname ${DEPLOY_PATH})
          scp -i ~/.ssh/deploy_key satvis-deploy.tar.gz ${SSH_USER}@${SSH_HOST}:${PARENT_DIR}/

          # Extract and deploy on server
          ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} bash -s << ENDSSH
            set -e
            PARENT_DIR=\$(dirname ${DEPLOY_PATH})
            DEPLOY_NAME=\$(basename ${DEPLOY_PATH})
            cd "\$PARENT_DIR"

            # Backup current deployment if it exists
            if [ -d "\$DEPLOY_NAME" ]; then
              BACKUP_DIR="\${DEPLOY_NAME}-backup-\$(date +%Y%m%d-%H%M%S)"
              mv "\$DEPLOY_NAME" "\$BACKUP_DIR"
              echo "✓ Backed up current deployment to \$BACKUP_DIR"

              # Keep only last 5 backups
              ls -dt "\${DEPLOY_NAME}-backup-"* 2>/dev/null | tail -n +6 | xargs -r rm -rf
            fi

            # Create deployment directory and extract new deployment
            mkdir -p "\$DEPLOY_NAME"
            tar -xzf satvis-deploy.tar.gz -C "\$DEPLOY_NAME/"
            rm satvis-deploy.tar.gz

            # Set correct permissions
            chmod -R 755 "\$DEPLOY_NAME/"

            echo "✓ Deployment completed successfully"
          ENDSSH

      - name: Verify deployment
        env:
          SSH_HOST: ${{ secrets.SSH_DEPLOY_HOST }}
          SSH_USER: ${{ secrets.SSH_DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.SSH_DEPLOY_PATH }}
        run: |
          ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} bash -s << ENDVERIFY
            if [ -f "${DEPLOY_PATH}/index.html" ]; then
              echo "✓ Verified: index.html exists"
              exit 0
            else
              echo "✗ Verification failed: index.html not found"
              exit 1
            fi
          ENDVERIFY

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Deployment summary
        if: success()
        run: |
          echo "## ✅ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
