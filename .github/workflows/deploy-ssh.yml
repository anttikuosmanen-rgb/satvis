name: Deploy to Server

on:
  push:
    branches:
      - production  # Deploy only on push to production branch
  workflow_dispatch:  # Allow manual deployment from Actions tab

jobs:
  deploy:
    # Use self-hosted runner with 'satvis-deploy' label
    # Self-hosted runner can access the deployment server without firewall issues
    runs-on: self-hosted
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Update TLE data
        run: npm run update-tle

      - name: Update prelaunch data
        run: |
          cd data/tle
          sh update-prelaunch-data.sh
          mv prelaunch.txt groups/

      - name: Build project
        env:
          SATVIS_BASE_PATH: ${{ secrets.SATVIS_BASE_PATH }}
        run: npm run build

      - name: Setup SSH
        env:
          SSH_HOST: ${{ secrets.SSH_DEPLOY_HOST }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_DEPLOY_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Debug: Check if secrets are accessible
          echo "Checking environment variables..."
          echo "SSH_HOST is set: $([ -n "${SSH_HOST}" ] && echo 'YES' || echo 'NO')"
          echo "SSH_HOST length: ${#SSH_HOST}"

          # Verify SSH_HOST is set
          if [ -z "${SSH_HOST}" ]; then
            echo "Error: SSH_HOST is not set or empty"
            exit 1
          fi

          # Add server to known_hosts
          echo "Adding host to known_hosts..."
          ssh-keyscan -H "${SSH_HOST}" 2>&1 | tee -a ~/.ssh/known_hosts || {
            echo "Error: ssh-keyscan failed for host"
            exit 1
          }

          echo "✓ SSH setup completed successfully"

      - name: Deploy to server
        env:
          SSH_HOST: ${{ secrets.SSH_DEPLOY_HOST }}
          SSH_USER: ${{ secrets.SSH_DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.SSH_DEPLOY_PATH }}
        run: |
          # Create deployment archive
          cd dist
          tar -czf ../satvis-deploy.tar.gz .
          cd ..

          # Upload the archive
          scp -i ~/.ssh/deploy_key satvis-deploy.tar.gz ${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}/

          # Extract and deploy on server
          ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} bash -s << ENDSSH
            set -e
            PARENT_DIR=\$(dirname ${DEPLOY_PATH})
            DEPLOY_NAME=\$(basename ${DEPLOY_PATH})
            cd "\$PARENT_DIR"

            # Backup current deployment if it exists
            if [ -d "\$DEPLOY_NAME" ]; then
              BACKUP_DIR="\${DEPLOY_NAME}-backup-\$(date +%Y%m%d-%H%M%S)"
              mv "\$DEPLOY_NAME" "\$BACKUP_DIR"
              echo "✓ Backed up current deployment to \$BACKUP_DIR"

              # Keep only last 5 backups
              ls -dt "\${DEPLOY_NAME}-backup-"* 2>/dev/null | tail -n +6 | xargs -r rm -rf
            fi

            # Create deployment directory and extract new deployment
            mkdir -p "\$DEPLOY_NAME"
            tar -xzf "\$DEPLOY_NAME/satvis-deploy.tar.gz" -C "\$DEPLOY_NAME/"
            rm "\$DEPLOY_NAME/satvis-deploy.tar.gz"

            # Set correct permissions
            chmod -R 755 "\$DEPLOY_NAME/"

            echo "✓ Deployment completed successfully"
          ENDSSH

      - name: Verify deployment
        env:
          SSH_HOST: ${{ secrets.SSH_DEPLOY_HOST }}
          SSH_USER: ${{ secrets.SSH_DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.SSH_DEPLOY_PATH }}
        run: |
          ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} bash -s << ENDVERIFY
            if [ -f "${DEPLOY_PATH}/index.html" ]; then
              echo "✓ Verified: index.html exists"
              exit 0
            else
              echo "✗ Verification failed: index.html not found"
              exit 1
            fi
          ENDVERIFY

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Deployment summary
        if: success()
        run: |
          echo "## ✅ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
